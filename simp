#!/usr/bin/env python3
from pathlib import Path
import os
import safer
import sys


def simp(args):
    args = [Path(a) for a in args]
    for arg in args:
        if arg.is_dir():
            for f in _all_files(arg):
                if f.suffix == '.py':
                    _simp(f)
        elif arg.suffix in ('.py', ''):
            _simp(arg)


def _simp(path):
    with safer.printer(path) as print:
        for line in _process_lines(path.read_text()):
            print(line)


def _process_lines(text):
    imports_done = False
    imports = []
    comments = []
    trailing = []
    was_blank = True

    for line in text.splitlines():
        if imports_done:
            yield line

        elif line.startswith('from ') or line.startswith('import '):
            while trailing and not trailing[0].strip():
                trailing.pop(0)
            if trailing:
                comments.append('')
                comments.extend(trailing)
                trailing.clear()
            imports.append(line)

        elif not imports:
            yield line
            was_blank = not line.strip()

        elif line.strip().startswith('#') or not line.strip():
            trailing.append(line)

        else:
            imports_done = True
            while comments and not comments[0]:
                comments.pop(0)

            if comments:
                if not was_blank:
                    yield ''
                yield from comments
            yield from sorted(imports)
            yield from trailing
            if not trailing or trailing[-1].strip():
                yield ''
            yield line


def _all_files(root):
    root = Path(root)
    for directory, sub_dirs, files in os.walk(root):
        path = Path(directory)
        if path == root:
            sub_dirs[:] = (i for i in sub_dirs if i not in ('build', 'dist'))

        sub_dirs[:] = (i for i in sub_dirs if not i.startswith('.'))
        files[:] = (i for i in files if not i.startswith('.'))

        yield from (path / f for f in files)


if __name__ == '__main__':
    simp(sys.argv[1:] or ['.'])
